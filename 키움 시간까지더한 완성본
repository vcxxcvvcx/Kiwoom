import requests
import pymysql
import csv
import time
from datetime import datetime
from kiwoom_key import appkey, secretkey

# MySQL ì„¤ì •
MYSQL_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': '5737',
    'database': 'stock_data',
    'charset': 'utf8mb4'
}

# ì•ˆì „í•œ ìˆ«ì ë³€í™˜
def safe_int(value):
    try:
        return int(str(value).replace(',', '').strip())
    except:
        return 0

# ì ‘ê·¼í† í° ë°œê¸‰
def get_token():
    url = 'https://api.kiwoom.com/oauth2/token'
    payload = {
        'grant_type': 'client_credentials',
        'appkey': appkey,
        'secretkey': secretkey
    }
    headers = {'Content-Type': 'application/json;charset=UTF-8'}
    res = requests.post(url, json=payload, headers=headers)
    return res.json().get("token")

# ë‹¨ì¼ ì¢…ëª© ì¡°íšŒ
def fetch_stock_info(token, shcode):
    url = "https://api.kiwoom.com/api/dostk/mrkcond"
    headers = {
        "Content-Type": "application/json",
        "authorization": f"Bearer {token}",
        "api-id": "ka10007"
    }
    payload = { "stk_cd": shcode }
    response = requests.post(url, headers=headers, json=payload)
    if response.status_code == 200:
        return response.json()
    else:
        return None

# ì €ì¥
def save_snapshot(data):
    with pymysql.connect(**MYSQL_CONFIG) as conn:
        with conn.cursor() as cur:
            sql = """
            INSERT INTO stock_snapshot (
                shcode, hname, price, change_pct, amount,
                listed_shares, total_offer_qty, total_bid_qty, created_at
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
            """
            cur.execute(sql, (
                data.get("stk_cd"),
                data.get("stk_nm"),
                safe_int(data.get("cur_prc")),
                float(data.get("flu_rt") or 0),
                safe_int(data.get("trde_qty")),
                safe_int(data.get("flo_stkcnt")),
                safe_int(data.get("tot_sel_req")),
                safe_int(data.get("tot_buy_req")),
                datetime.now()
            ))
        conn.commit()

# CSV ëª©ë¡
CSV_FILES = [
    "ì½”ìŠ¤í”¼_ì „ì¢…ëª©.csv",
    "ì½”ìŠ¤ë‹¥_ì „ì¢…ëª©.csv",
    "ì½”ë„¥ìŠ¤_ì „ì¢…ëª©.csv",
    "ë„¥ìŠ¤íŠ¸_ì „ì¢…ëª©.csv"
]

# CSVì—ì„œ ì¢…ëª©ì½”ë“œ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
def load_stock_list():
    stock_list = []
    for file in CSV_FILES:
        with open(file, newline='', encoding='utf-8-sig') as f:
            reader = csv.DictReader(f)
            for row in reader:
                stock_list.append({
                    "code": row["ì¢…ëª©ì½”ë“œ"],
                    "name": row["ì¢…ëª©ëª…"]
                })
    return stock_list

# â–¶ ì‹¤í–‰ ì‹œì‘
if __name__ == '__main__':
    ì‹¤í–‰ì‹œê°„ = {"15:42", "16:46", "20:01"}
    ì‹¤í–‰ì™„ë£Œ = False

    while True:
        now = datetime.now().strftime("%H:%M")

        if now in ì‹¤í–‰ì‹œê°„ and not ì‹¤í–‰ì™„ë£Œ:
            print(f"\nğŸš€ {now} ì‹¤í–‰ ì‹œì‘")
            token = get_token()
            stock_list = load_stock_list()

            fail_list = []
            success_count = 0

            for stock in stock_list:
                info = fetch_stock_info(token, stock["code"])
                if info:
                    try:
                        save_snapshot(info)
                        print(f"âœ… ì €ì¥: {stock['name']}")
                        success_count += 1
                    except Exception as e:
                        print(f"âŒ ì €ì¥ ì˜¤ë¥˜: {stock['code']} - {e}")
                        fail_list.append(stock)
                else:
                    print(f"âŒ ì¡°íšŒ ì‹¤íŒ¨: {stock['code']}")
                    fail_list.append(stock)

                time.sleep(0.2)

            print(f"\nâœ… ì´ ì €ì¥ ì™„ë£Œ: {success_count}ê°œ")
            if fail_list:
                print(f"âš ï¸ ì‹¤íŒ¨í•œ ì¢…ëª© ìˆ˜: {len(fail_list)}")
                with open("fail_list.txt", "w", encoding="utf-8") as f:
                    for stock in fail_list:
                        f.write(f"{stock['code']},{stock['name']}\n")
                print("ğŸ“ ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ: fail_list.txt")

            ì‹¤í–‰ì™„ë£Œ = True  # ë°˜ë³µ ë°©ì§€
        else:
            print(f"âŒ› ì‹¤í–‰ ëŒ€ê¸°ì¤‘... í˜„ì¬ì‹œê°„: {now}", end="\r")
            time.sleep(10)
